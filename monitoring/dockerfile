FROM prom/prometheus:latest

USER root

# Install envsubst (gettext-base provides it on Debian/Ubuntu)
RUN apt-get update && apt-get install -y gettext-base && rm -rf /var/lib/apt/lists/*

# Copy Prometheus config
COPY prometheus.yaml /etc/prometheus/prometheus.yaml

# Replace env vars and start Prometheus
CMD ["/bin/sh", "-c", "envsubst < /etc/prometheus/prometheus.yaml > /tmp/prometheus.yaml && exec prometheus --config.file=/tmp/prometheus.yaml --web.enable-lifecycle --storage.tsdb.path=/prometheus"]
